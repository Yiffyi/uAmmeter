#include <stm32f1xx.h>
#include "oled.h"

const unsigned char pos[6] = {0x01, 0x16, 0x2B, 0x40, 0x55, 0x6A};

const unsigned char num[11][84] = {
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xFF, 0x01, 0x00, 0xE0, 0xFF, 0x07, 0x00, 0xF8, 0xFF, 0x1F, 0x00, 0xFC, 0xFF, 0x3F, 0x00, 0x7E, 0x00, 0x7E, 0x00, 0x1E, 0x00, 0x78, 0x00, 0x0F, 0x00, 0xF0, 0x00, 0x07, 0x00, 0xE0, 0x00, 0x07, 0x00, 0xE0, 0x00, 0x07, 0x00, 0xE0, 0x00, 0x0F, 0x00, 0xF0, 0x00, 0x1E, 0x00, 0x78, 0x00, 0x7E, 0x00, 0x7E, 0x00, 0xFC, 0xFF, 0x3F, 0x00, 0xF8, 0xFF, 0x1F, 0x00, 0xF0, 0xFF, 0x07, 0x00, 0x80, 0xFF, 0x01}, // "0",0
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // "1",1
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x3C, 0x00, 0xC0, 0x00, 0x1E, 0x00, 0xE0, 0x00, 0x0E, 0x00, 0xF8, 0x00, 0x07, 0x00, 0xFC, 0x00, 0x07, 0x00, 0xFE, 0x00, 0x07, 0x80, 0xFF, 0x00, 0x07, 0xC0, 0xEF, 0x00, 0x0F, 0xF0, 0xE3, 0x00, 0x1F, 0xFC, 0xE1, 0x00, 0xFE, 0xFF, 0xE0, 0x00, 0xFC, 0x3F, 0xE0, 0x00, 0xF8, 0x1F, 0xE0, 0x00, 0xF0, 0x03, 0xE0, 0x00, 0x00, 0x00, 0xE0, 0x00, 0x00, 0x00, 0xE0, 0x00, 0x00, 0x00, 0x00}, // "2",2
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x78, 0x00, 0x1E, 0x00, 0x70, 0x00, 0x0E, 0x00, 0xF0, 0x00, 0x07, 0x00, 0xE0, 0x00, 0x07, 0x1C, 0xE0, 0x00, 0x07, 0x1C, 0xE0, 0x00, 0x07, 0x1C, 0xE0, 0x00, 0x0F, 0x3E, 0xF0, 0x00, 0x1F, 0x7F, 0x78, 0x00, 0xFE, 0xFF, 0x7F, 0x00, 0xFE, 0xFF, 0x3F, 0x00, 0xFC, 0xF3, 0x1F, 0x00, 0xF0, 0xC1, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // "3",3
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0x00, 0x00, 0x00, 0xE0, 0x00, 0x00, 0x00, 0xF8, 0x00, 0x00, 0x00, 0xFC, 0x00, 0x00, 0x00, 0xFE, 0x00, 0x00, 0x00, 0xEF, 0x00, 0x00, 0x80, 0xE7, 0x00, 0x00, 0xE0, 0xE1, 0x00, 0x00, 0xF0, 0xE0, 0x00, 0x00, 0x78, 0xE0, 0x00, 0x00, 0xFC, 0xFF, 0xFF, 0x00, 0xFE, 0xFF, 0xFF, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0xE0, 0x00, 0x00, 0x00, 0xE0, 0x00, 0x00, 0x00, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00}, // "4",4
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x78, 0x00, 0x00, 0x00, 0x70, 0x00, 0xFF, 0x0F, 0xF0, 0x00, 0xFF, 0x0F, 0xE0, 0x00, 0xFF, 0x0F, 0xE0, 0x00, 0x07, 0x0E, 0xE0, 0x00, 0x07, 0x0E, 0xE0, 0x00, 0x07, 0x1E, 0xF0, 0x00, 0x07, 0x1E, 0xF0, 0x00, 0x07, 0x7C, 0x78, 0x00, 0x07, 0xFC, 0x7F, 0x00, 0x07, 0xF8, 0x3F, 0x00, 0x07, 0xF0, 0x1F, 0x00, 0x00, 0xC0, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // "5",5
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x07, 0x00, 0x00, 0xFE, 0x1F, 0x00, 0x80, 0xFF, 0x3F, 0x00, 0xC0, 0xFF, 0x7F, 0x00, 0xE0, 0x3F, 0x78, 0x00, 0xF0, 0x3B, 0xF0, 0x00, 0xF8, 0x1C, 0xE0, 0x00, 0x7C, 0x1C, 0xE0, 0x00, 0x3E, 0x1C, 0xE0, 0x00, 0x1E, 0x1C, 0xE0, 0x00, 0x0F, 0x3C, 0xF0, 0x00, 0x0E, 0x7C, 0x78, 0x00, 0x04, 0xF8, 0x7F, 0x00, 0x00, 0xF0, 0x3F, 0x00, 0x00, 0xE0, 0x1F, 0x00, 0x00, 0xC0, 0x07, 0x00, 0x00, 0x00, 0x00}, // "6",6
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x07, 0x00, 0x40, 0x00, 0x07, 0x00, 0x78, 0x00, 0x07, 0x00, 0xFE, 0x00, 0x07, 0x80, 0x7F, 0x00, 0x07, 0xF0, 0x1F, 0x00, 0x07, 0xFC, 0x07, 0x00, 0x07, 0xFF, 0x01, 0x00, 0xC7, 0x3F, 0x00, 0x00, 0xFF, 0x0F, 0x00, 0x00, 0xFF, 0x03, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x3F, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00}, // "7",7
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x0F, 0x00, 0xF0, 0xE1, 0x1F, 0x00, 0xF8, 0xF3, 0x3F, 0x00, 0xFC, 0xF7, 0x7F, 0x00, 0xFE, 0x7F, 0x78, 0x00, 0x0E, 0x3F, 0xF0, 0x00, 0x0F, 0x1E, 0xE0, 0x00, 0x07, 0x1C, 0xE0, 0x00, 0x07, 0x1C, 0xE0, 0x00, 0x07, 0x1C, 0xE0, 0x00, 0x0F, 0x3E, 0xF0, 0x00, 0x1F, 0x7F, 0x78, 0x00, 0xFE, 0xFF, 0x7F, 0x00, 0xFC, 0xF7, 0x3F, 0x00, 0xF8, 0xE3, 0x1F, 0x00, 0xF0, 0xC1, 0x0F, 0x00, 0x00, 0x00, 0x00}, // "8",8
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0, 0x03, 0x00, 0x00, 0xF8, 0x07, 0x00, 0x00, 0xFC, 0x0F, 0x00, 0x00, 0xFE, 0x1F, 0x20, 0x00, 0x1E, 0x3E, 0x70, 0x00, 0x0F, 0x3C, 0xF0, 0x00, 0x07, 0x38, 0x78, 0x00, 0x07, 0x38, 0x7C, 0x00, 0x07, 0x38, 0x3E, 0x00, 0x07, 0x38, 0x1F, 0x00, 0x0F, 0xDC, 0x0F, 0x00, 0x1E, 0xFC, 0x07, 0x00, 0xFE, 0xFF, 0x03, 0x00, 0xFC, 0xFF, 0x01, 0x00, 0xF8, 0x7F, 0x00, 0x00, 0xE0, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00}, // "9",9
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // ".",10
};

uint8_t screenDigCurrent[6] = {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF};

uint8_t init_cmd[14] = {
	0xAE, 0xD5, 0x80, 0xA8, 0x1F, 0xD3, 0x00, 0x40, 0x8d, 0x14,
	0xA1, 0xC8, 0xDA, 0x02, 0x81, 0x00, 0xD9, 0xF1, 0xDB, 0x30,
	0x20, 0x01, 0xA6, 0xAF};
uint8_t refresh_cmd1[6] = {0x21, 0x00, 0x7F, 0x22, 0x00, 0x03};
uint8_t refresh_cmd2[85] = {0x40};
uint8_t clear_cmd[6] = {0x21, 0x00, 0x7F, 0x22, 0x00, 0x03};

I2C_HandleTypeDef *hOLED;

void OLED_Refresh(uint8_t n, uint8_t p)
{
	if (screenDigCurrent[p] == n)
	{
		return;
	}
	else
	{
		screenDigCurrent[p] = n;
	}
	refresh_cmd1[1] = pos[p];

	HAL_I2C_Master_Transmit(hOLED, OLED_ADDR, refresh_cmd1, 6, 1000);

	for (int i = 0; i < 84; i++)
	{
		refresh_cmd2[2 + i] = num[n][i];
	}

	HAL_I2C_Master_Transmit(hOLED, OLED_ADDR, refresh_cmd2, 85, 1000);
}

void OLED_Clear()
{
	HAL_I2C_Master_Transmit(hOLED, OLED_ADDR, clear_cmd, 6, 1000);
	// clear buffer
	for (int i = 0; i < 6; i++)
	{
		screenDigCurrent[i] = 0xFF;
	}

	/*
	SW_I2C_write(0x40); // data flag
	SW_I2C_wait_ACK();
	for (i = 0; i < 4096; i++)
	{
		SW_I2C_write(0x00);
		SW_I2C_wait_ACK();
	}
	SW_I2C_stop();
	*/
}

void OLED_Init(I2C_HandleTypeDef *hi2c)
{
	hOLED = hi2c;
	HAL_I2C_Master_Transmit(hOLED, OLED_ADDR, init_cmd, 24, 1000);
}
